<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inspeção Tecidos da Filtragem</title>
<style>
:root{--bg:#f5f7f9;--card:#fff;--accent:#1b6b6b;--muted:#6b7a80}
*{box-sizing:border-box}
body{font-family:Inter, Arial, sans-serif;background:var(--bg);margin:0;padding:18px;color:#0b2530}

h1{margin:0 0 5px;text-align:center;color:var(--accent)}
.wrap{max-width:1100px;margin:0 auto;display:grid;gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 4px 18px rgba(13,40,46,0.06)}
    
form{display:block}
label{display:block;font-weight:600;margin-top:8px}
input,select,textarea,button{width:100%;padding:8px;border-radius:8px;border:1px solid #d7e0e4;margin-top:6px}
.row{display:flex;gap:8px}
.row> *{flex:1}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.actions{display:flex;gap:8px;margin-top:10px}
button.primary{background:var(--accent);color:#fff;border:none;cursor:pointer}
button.ghost{background:#eef5f4;border:none;color:#133}
button:disabled{opacity:0.6;cursor:not-allowed}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:6px;border:1px solid #e6eef0;text-align:left}
th{background:#f1f6f6}
small.note{color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.badge-warning{background:#fff3cd;color:#856404}
.badge-danger{background:#f8d7da;color:#721c24}
.badge-success{background:#d1edff;color:#155724}
.loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin-right:8px;}
@keyframes spin{to{transform:rotate(360deg);}}
.status{text-align:center;padding:10px;margin:10px 0;border-radius:8px;font-weight:600}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.status.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb;}
@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<h1>Inspeção de Tecidos de Filtragem</br>(Instalação & Inspeção)</h1>
<div class="wrap">
<div id="statusMessage" class="status" style="display:none;"></div>
<div class="card grid-2">
<div>
<h3>Instalar / Substituir Tecido</h3>
<form id="formInstal">
<label>Código do tecido</label>
<div class="row">
<input id="inst_codigo" placeholder="T0000001" required />
<button type="button" id="btnGerar" class="ghost">Gerar</button>
</div>
<div class="row">
<select id="inst_filtro" required>
<option value="">Selecione Filtro...</option>
<option value="1">Filtro 1</option>
<option value="2">Filtro 2</option>
<option value="3">Filtro 3</option>
<option value="4">Filtro 4</option>
</select>
<select id="inst_placa" required>
<option value="">Selecione placa...</option>
</select>
</div>
<div class="row">
<select id="inst_lado" required>
<option value="">Lado...</option>
<option value="A">A</option>
<option value="B">B</option>
</select>
<input type="date" id="inst_data" required />
</div>
<label>Responsável pela instalação</label>
<input id="inst_responsavel" required />
<label>Observações (opcional)</label>
<textarea id="inst_obs" rows="2"></textarea>
<div class="actions">
<button class="primary" type="submit" id="btnSalvarInstalacao">
<span id="loadingInstalacao" class="loading" style="display:none;"></span>
Salvar Instalação
</button>
<button type="button" id="btnExportFabrics">Exportar Tecidos CSV</button>
</div>
<small class="note">Ao instalar um novo tecido na mesma placa+lado, o tecido anterior será marcado como substituído automaticamente.</small>
</form>
</div>
<div>
<h3>Registrar Anomalia na Inspeção</h3>
<form id="formInsp">
<label>Filtrar tecido ativo por</label>
<div class="row">
<select id="filtroBusca"><option value="">Filtro...</option><option value="1">Filtro 1</option><option value="2">Filtro 2</option><option value="3">Filtro 3</option><option value="4">Filtro 4</option></select>
<select id="placaBusca"><option value="">Placa...</option></select>
</div>
<label>Ou selecione o código do tecido</label>
<select id="insp_codigo"><option value="">-- escolher tecido ativo --</option></select>
<div class="row">
<input id="insp_filtro" readonly placeholder="Filtro" />
<input id="insp_placa" readonly placeholder="Placa" />
<input id="insp_total_anomalias" readonly placeholder="Anomalias" />
</div>
<div class="row">
<input id="insp_lado" readonly placeholder="Lado" />
<select id="insp_quadrante" required><option value="">Quadrante...</option><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select>
</div>
<label>Tipo de Anomalia</label>
<select id="insp_condicao" required>
<option value="">Selecione a anomalia...</option>
<option>Desgaste</option>
<option>Furo</option>
<option>Rasgo</option>
<option>Obstrução</option>
<option>Outro</option>
</select>
<label>Responsável pela Inspeção</label>
<input id="insp_responsavel" required />
<label>Descrição da Anomalia</label>
<textarea id="insp_obs" rows="2" placeholder="Descreva detalhadamente a anomalia encontrada..."></textarea>
<div class="actions">
<button class="primary" type="submit" id="btnRegistrarAnomalia">
<span id="loadingAnomalia" class="loading" style="display:none;"></span>
Registrar Anomalia
</button>
<button type="button" id="btnExportInsps">Exportar Anomalias CSV</button>
</div>
<small class="note">Apenas anomalias são registradas. Tecidos sem problemas não geram registros.</small>
</form>
</div>
</div>
<div class="card">
<h3>Tecidos (histórico)</h3>
<div class="actions">
<button type="button" id="btnAtualizarDados" class="ghost">Atualizar Dados</button>
</div>
<table id="tbFabrics"><thead><tr><th>Código</th><th>Filtro</th><th>Placa</th><th>Lado</th><th>Instalado</th><th>Instalador</th><th>Anomalias</th><th>Status</th><th>Removido</th><th>Ações</th></tr></thead><tbody></tbody></table>
</div>
<div class="card">
<h3>Histórico de Anomalias por Tecido</h3>
<table id="tbInsps"><thead><tr><th>Código</th><th>Total Anomalias</th><th>Primeira</th><th>Última</th><th>Tipos</th><th>Detalhes</th></tr></thead><tbody></tbody></table>
</div>
</div>
<script>
// CONFIGURAÇÃO - SUBSTITUA PELA SUA URL DO APPS SCRIPT
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxEeJ5RJPILbAp5yn_qRRjU77EF9YrGMuVYbJnIYwhmXwVfGEQVkBCUBYKf6Yb7Fg6j/exec';

// STORAGE KEYS
const KEY_FABRICS = 'tecidos_v3';
const placasPorFiltro = { '1': 31, '2': 111, '3': 111, '4': 111 };

// DOM
const inst_codigo = document.getElementById('inst_codigo');
const btnGerar = document.getElementById('btnGerar');
const inst_filtro = document.getElementById('inst_filtro');
const inst_placa = document.getElementById('inst_placa');
const inst_lado = document.getElementById('inst_lado');
const inst_data = document.getElementById('inst_data');
const inst_responsavel = document.getElementById('inst_responsavel');
const inst_obs = document.getElementById('inst_obs');
const formInstal = document.getElementById('formInstal');
const btnExportFabrics = document.getElementById('btnExportFabrics');
const btnSalvarInstalacao = document.getElementById('btnSalvarInstalacao');
const loadingInstalacao = document.getElementById('loadingInstalacao');

const filtroBusca = document.getElementById('filtroBusca');
const placaBusca = document.getElementById('placaBusca');
const insp_codigo = document.getElementById('insp_codigo');
const insp_filtro = document.getElementById('insp_filtro');
const insp_placa = document.getElementById('insp_placa');
const insp_total_anomalias = document.getElementById('insp_total_anomalias');
const insp_lado = document.getElementById('insp_lado');
const insp_quadrante = document.getElementById('insp_quadrante');
const insp_condicao = document.getElementById('insp_condicao');
const insp_responsavel = document.getElementById('insp_responsavel');
const insp_obs = document.getElementById('insp_obs');
const formInsp = document.getElementById('formInsp');
const btnExportInsps = document.getElementById('btnExportInsps');
const btnRegistrarAnomalia = document.getElementById('btnRegistrarAnomalia');
const loadingAnomalia = document.getElementById('loadingAnomalia');

const tbFabrics = document.querySelector('#tbFabrics tbody');
const tbInsps = document.querySelector('#tbInsps tbody');
const btnAtualizarDados = document.getElementById('btnAtualizarDados');
const statusMessage = document.getElementById('statusMessage');

// FUNÇÕES UTILITÁRIAS
const read = (k) => JSON.parse(localStorage.getItem(k) || '[]');
const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function showStatus(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status ${type}`;
    statusMessage.style.display = 'block';
    setTimeout(() => {
        statusMessage.style.display = 'none';
    }, 5000);
}

function formatDate(iso) { 
    if (!iso) return ''; 
    let d = new Date(iso); 
    return d.toLocaleString('pt-BR'); 
}

function formatDateShort(iso) { 
    if (!iso) return ''; 
    let d = new Date(iso); 
    return d.toLocaleDateString('pt-BR'); 
}

function esc(s) { 
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
}

function toCSV(arr) {
    if (!arr.length) return '';
    const keys = Object.keys(arr[0]);
    const lines = [keys.join(';')];
    arr.forEach(o => {
        const row = keys.map(k => '"' + String((o[k] === undefined || o[k] === null) ? '' : o[k]).replace(/"/g, '""') + '"').join(';');
        lines.push(row);
    });
    return lines.join('\n');
}

function download(content, filename) { 
    let blob = new Blob([content], { type: 'text/csv;charset=utf-8;' }); 
    let url = URL.createObjectURL(blob); 
    let a = document.createElement('a'); 
    a.href = url; 
    a.download = filename; 
    a.click(); 
    URL.revokeObjectURL(url); 
}

function traduzirStatus(status) {
    const statusMap = {
        'em_operacao': 'Em Operação',
        'substituido': 'Substituído'
    };
    return statusMap[status] || status;
}

function getBadgeClass(totalAnomalias) {
    if (totalAnomalias === 0) return 'badge-success';
    if (totalAnomalias <= 2) return 'badge-warning';
    return 'badge-danger';
}

// FUNÇÕES GOOGLE SHEETS
async function saveToGoogleSheets(sheetName, rowData) {
    try {
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'append',
                sheetName: sheetName,
                row: rowData
            })
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Erro ao salvar no Google Sheets:', error);
        return { success: false, message: error.toString() };
    }
}

// FUNÇÕES DE DADOS
function gerarCodigo() {
    let fabrics = read(KEY_FABRICS);
    let max = 0;
    fabrics.forEach(f => {
        let m = (f.codigo || '').match(/^T0*([0-9]+)$/);
        if (m) { let n = parseInt(m[1], 10); if (n > max) max = n; }
    });
    return 'T' + String(max + 1).padStart(7, '0');
}

function preencherPlacas(selectEl, filtroVal, includeEmpty = true) {
    selectEl.innerHTML = '';
    if (includeEmpty) { 
        let opt = document.createElement('option'); 
        opt.value = ''; 
        opt.textContent = 'Placa...'; 
        selectEl.appendChild(opt); 
    }
    if (!filtroVal) return;
    let total = placasPorFiltro[filtroVal];
    for (let i = 1; i <= total; i++) { 
        let o = document.createElement('option'); 
        o.value = i; 
        o.textContent = i; 
        selectEl.appendChild(o); 
    }
}

function atualizarTecidosPorFiltro() {
    const filtro = filtroBusca.value;
    const placa = placaBusca.value;
    
    let fabrics = read(KEY_FABRICS).filter(f => f.status === 'em_operacao');
    
    if (filtro) {
        fabrics = fabrics.filter(f => String(f.filtro) === filtro);
    }
    
    if (placa) {
        fabrics = fabrics.filter(f => String(f.placa) === placa);
    }
    
    insp_codigo.innerHTML = '<option value="">-- escolher tecido ativo --</option>';
    fabrics.forEach(f => {
        let opt = document.createElement('option');
        opt.value = f.codigo;
        const totalAnom = f.anomalias ? f.anomalias.length : 0;
        opt.textContent = `${f.codigo} — F${f.filtro} P${f.placa} L${f.lado} (${totalAnom} anomalias)`;
        insp_codigo.appendChild(opt);
    });
    
    // Se só há um resultado, selecione automaticamente
    if (fabrics.length === 1) {
        insp_codigo.value = fabrics[0].codigo;
        insp_codigo.dispatchEvent(new Event('change'));
    }
}

function carregarTabelas() {
    let fabrics = read(KEY_FABRICS).slice().sort((a, b) => new Date(b.instalado_em) - new Date(a.instalado_em));
    tbFabrics.innerHTML = '';
    fabrics.forEach(f => { 
        const totalAnom = f.anomalias ? f.anomalias.length : 0;
        let tr = document.createElement('tr'); 
        tr.innerHTML = `
            <td><strong>${f.codigo}</strong></td>
            <td>${f.filtro}</td>
            <td>${f.placa}</td>
            <td>${f.lado}</td>
            <td>${formatDate(f.instalado_em)}</td>
            <td>${esc(f.instalador)}</td>
            <td><span class="badge ${getBadgeClass(totalAnom)}">${totalAnom} anomalia(s)</span></td>
            <td>${traduzirStatus(f.status)}</td>
            <td>${f.removido_em ? formatDate(f.removido_em) : ''}</td>
            <td>
                ${f.anomalias && f.anomalias.length > 0 ? 
                    `<button type="button" onclick="verDetalhesAnomalias('${f.codigo}')" class="ghost" style="padding:4px 8px;font-size:12px;">Ver Detalhes</button>` : 
                    '-'
                }
            </td>
        `; 
        tbFabrics.appendChild(tr); 
    });

    // Tabela de resumo de anomalias por tecido
    tbInsps.innerHTML = '';
    fabrics.forEach(f => {
        if (f.anomalias && f.anomalias.length > 0) {
            const totalAnom = f.anomalias.length;
            const primeiraAnom = f.anomalias[0];
            const ultimaAnom = f.anomalias[f.anomalias.length - 1];
            
            // Contar tipos de anomalias
            const tiposAnomalias = {};
            f.anomalias.forEach(a => {
                tiposAnomalias[a.condicao] = (tiposAnomalias[a.condicao] || 0) + 1;
            });
            const tiposStr = Object.entries(tiposAnomalias).map(([tipo, count]) => `${tipo} (${count})`).join(', ');
            
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${f.codigo}</strong></td>
                <td><span class="badge ${getBadgeClass(totalAnom)}">${totalAnom}</span></td>
                <td>${formatDateShort(primeiraAnom.data)}</td>
                <td>${formatDateShort(ultimaAnom.data)}</td>
                <td>${tiposStr}</td>
                <td><button type="button" onclick="verDetalhesAnomalias('${f.codigo}')" class="ghost" style="padding:4px 8px;font-size:12px;">Ver Todas</button></td>
            `;
            tbInsps.appendChild(tr);
        }
    });

    preencherSelectTecidos();
}

function preencherSelectTecidos() {
    let fabrics = read(KEY_FABRICS).filter(f => f.status === 'em_operacao');
    insp_codigo.innerHTML = '<option value="">-- escolher tecido ativo --</option>';
    fabrics.forEach(f => {
        let opt = document.createElement('option'); 
        opt.value = f.codigo; 
        const totalAnom = f.anomalias ? f.anomalias.length : 0;
        opt.textContent = `${f.codigo} — F${f.filtro} P${f.placa} L${f.lado} (${totalAnom} anomalias)`;
        insp_codigo.appendChild(opt);
    });
}

// FUNÇÃO PARA VER DETALHES DAS ANOMALIAS
function verDetalhesAnomalias(codigo) {
    let fabrics = read(KEY_FABRICS);
    let f = fabrics.find(x => x.codigo === codigo);
    
    if (!f || !f.anomalias || f.anomalias.length === 0) {
        alert('Nenhuma anomalia encontrada para este tecido.');
        return;
    }
    
    let detalhes = `TECIDO: ${f.codigo} - F${f.filtro} P${f.placa} L${f.lado}\n\n`;
    detalhes += 'HISTÓRICO DE ANOMALIAS:\n\n';
    
    f.anomalias.forEach((a, index) => {
        detalhes += `${index + 1}. ${formatDate(a.data)}\n`;
        detalhes += `   Quadrante: ${a.quadrante}\n`;
        detalhes += `   Tipo: ${a.condicao}\n`;
        detalhes += `   Responsável: ${a.responsavel}\n`;
        if (a.observacoes) {
            detalhes += `   Observações: ${a.observacoes}\n`;
        }
        detalhes += '\n';
    });
    
    alert(detalhes);
}

// EVENT LISTENERS
btnGerar.addEventListener('click', () => {
    const novoCodigo = gerarCodigo();
    inst_codigo.value = novoCodigo;
    inst_codigo.focus();
});

inst_filtro.addEventListener('change', () => preencherPlacas(inst_placa, inst_filtro.value));

formInstal.addEventListener('submit', async e => {
    e.preventDefault();
    
    const codigo = inst_codigo.value.trim();
    const filtro = inst_filtro.value;
    const placa = inst_placa.value;
    const lado = inst_lado.value;
    const data = inst_data.value;
    const instalador = inst_responsavel.value.trim();
    const obs = inst_obs.value.trim();
    
    if (!codigo) return alert('Informe ou gere o código do tecido.');
    
    // Mostrar loading
    loadingInstalacao.style.display = 'inline-block';
    btnSalvarInstalacao.disabled = true;
    
    try {
        let fabrics = read(KEY_FABRICS);
        
        // Verificar se há tecido ativo na mesma posição
        const tecidoAtivo = fabrics.find(f => 
            f.filtro == filtro && 
            String(f.placa) === String(placa) && 
            f.lado === lado && 
            f.status === 'em_operacao'
        );

        if (tecidoAtivo && !confirm(`Já existe o tecido ${tecidoAtivo.codigo} ativo nesta posição. Deseja substituí-lo?`)) {
            return;
        }

        // Marcar tecido anterior como substituído
        if (tecidoAtivo) {
            const tecidoAtualizado = {
                ...tecidoAtivo,
                status: 'substituido',
                removido_em: new Date().toISOString()
            };
            
            // Atualizar no cache local
            fabrics = fabrics.map(f => 
                f.codigo === tecidoAtivo.codigo ? tecidoAtualizado : f
            );
            write(KEY_FABRICS, fabrics);
        }

        // Criar novo tecido
        const novoTecido = {
            codigo,
            filtro: Number(filtro),
            placa: Number(placa),
            lado,
            instalado_em: new Date(data + 'T00:00:00').toISOString(),
            instalador,
            obs_instalacao: obs,
            status: 'em_operacao',
            removido_em: null,
            anomalias: []
        };

        // Preparar dados para o Google Sheets
        const rowData = [
            codigo,
            Number(filtro),
            Number(placa),
            lado,
            new Date(data + 'T00:00:00').toISOString(),
            instalador,
            obs,
            'em_operacao',
            null
        ];

        // Salvar no Google Sheets
        const result = await saveToGoogleSheets('Tecidos', rowData);
        
        if (result.success) {
            // Salvar no cache local
            fabrics.push(novoTecido);
            write(KEY_FABRICS, fabrics);
            
            formInstal.reset(); 
            inst_data.valueAsDate = new Date(); 
            carregarTabelas(); 
            showStatus('Instalação registrada com sucesso!', 'success');
        } else {
            showStatus(`Erro ao salvar: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar instalação:', error);
        showStatus(`Erro ao salvar instalação: ${error.message}`, 'error');
    } finally {
        // Ocultar loading
        loadingInstalacao.style.display = 'none';
        btnSalvarInstalacao.disabled = false;
    }
});

insp_codigo.addEventListener('change', () => {
    const codigo = insp_codigo.value;
    if (!codigo) { 
        insp_filtro.value = ''; 
        insp_placa.value = ''; 
        insp_lado.value = '';
        insp_total_anomalias.value = '';
        return; 
    }
    let f = read(KEY_FABRICS).find(x => x.codigo === codigo);
    if (f) { 
        insp_filtro.value = f.filtro; 
        insp_placa.value = f.placa; 
        insp_lado.value = f.lado;
        const totalAnom = f.anomalias ? f.anomalias.length : 0;
        insp_total_anomalias.value = `${totalAnom} anomalia(s)`;
    }
});

filtroBusca.addEventListener('change', () => {
    preencherPlacas(placaBusca, filtroBusca.value);
    atualizarTecidosPorFiltro();
});

placaBusca.addEventListener('change', atualizarTecidosPorFiltro);

formInsp.addEventListener('submit', async e => {
    e.preventDefault();
    
    const codigo = insp_codigo.value;
    const condicao = insp_condicao.value;
    if (!codigo) return alert('Selecione o tecido ativo.');
    if (!condicao) return alert('Selecione o tipo de anomalia.');
    
    // Mostrar loading
    loadingAnomalia.style.display = 'inline-block';
    btnRegistrarAnomalia.disabled = true;
    
    try {
        let fabrics = read(KEY_FABRICS);
        let f = fabrics.find(x => x.codigo === codigo);
        if (!f) return alert('Tecido não encontrado.');

        // Registrar nova anomalia
        const novaAnomalia = {
            codigo_tecido: codigo,
            data: new Date().toISOString(),
            quadrante: insp_quadrante.value,
            condicao,
            responsavel: insp_responsavel.value.trim(),
            observacoes: insp_obs.value.trim()
        };

        // Preparar dados para o Google Sheets
        const rowData = [
            codigo,
            new Date().toISOString(),
            insp_quadrante.value,
            condicao,
            insp_responsavel.value.trim(),
            insp_obs.value.trim()
        ];

        // Salvar no Google Sheets
        const result = await saveToGoogleSheets('Anomalias', rowData);
        
        if (result.success) {
            // Salvar no cache local
            if (!f.anomalias) f.anomalias = [];
            f.anomalias.push(novaAnomalia);
            write(KEY_FABRICS, fabrics);
            
            formInsp.reset();
            insp_filtro.value = '';
            insp_placa.value = '';
            insp_lado.value = '';
            insp_total_anomalias.value = '';
            carregarTabelas();
            showStatus('Anomalia registrada com sucesso!', 'success');
        } else {
            showStatus(`Erro ao salvar: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao registrar anomalia:', error);
        showStatus(`Erro ao registrar anomalia: ${error.message}`, 'error');
    } finally {
        // Ocultar loading
        loadingAnomalia.style.display = 'none';
        btnRegistrarAnomalia.disabled = false;
    }
});

// EXPORT CSV
btnExportFabrics.addEventListener('click', () => { 
    let arr = read(KEY_FABRICS).slice().sort((a, b) => new Date(b.instalado_em) - new Date(a.instalado_em)); 
    if (!arr.length) return alert('Sem tecidos para exportar.'); 
    download(toCSV(arr), 'tecidos_v3.csv'); 
});

btnExportInsps.addEventListener('click', () => {
    let fabrics = read(KEY_FABRICS);
    let todasAnomalias = [];
    
    fabrics.forEach(f => { 
        if (f.anomalias) {
            f.anomalias.forEach(a => { 
                todasAnomalias.push({
                    codigo_tecido: f.codigo,
                    filtro: f.filtro,
                    placa: f.placa,
                    lado: f.lado,
                    data_anomalia: a.data,
                    quadrante: a.quadrante,
                    tipo_anomalia: a.condicao,
                    responsavel: a.responsavel,
                    observacoes: a.observacoes,
                    status_tecido: f.status
                }); 
            });
        }
    });
    
    if (!todasAnomalias.length) return alert('Nenhuma anomalia registrada para exportar.');
    download(toCSV(todasAnomalias), 'anomalias_tecidos_detalhadas.csv');
});

btnAtualizarDados.addEventListener('click', () => {
    carregarTabelas();
    showStatus('Dados atualizados do cache local.', 'info');
});

// INIT
function init() {
    preencherPlacas(inst_placa, inst_filtro.value, true);
    preencherPlacas(placaBusca, filtroBusca.value, true);
    carregarTabelas();
    inst_data.valueAsDate = new Date();
    
    showStatus('Sistema carregado. Use o botão "Atualizar Dados" para sincronizar.', 'info');
}

// Inicializar a aplicação
init();
</script>
</body>
</html>